---
title: "Dynamics of aquatic and soil-derived bacteria in a temperate lake"
author: "Tajinder Singh, Nathan I. Wisnoski, and Jay T. Lennon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document:
    fig_caption: yes
    keep_tex: yes
header-includes:
- \usepackage{array}
- \usepackage{graphics}
---
---


normal para text


# main header

## sub header

### sub-sub header

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.align = "center",
  message = FALSE,
  warning = 'hide')
```

First, we'll load the packages we'll need for the analysis, as well as some other functions.

```{r packages, results='hide'}
# Import Required Packages

library(tidyverse)   
library(vegan)
library(viridis)
library(lubridate)
library(cluster)
library(dtwclust)
library(readxl)
library(writexl)


source("bin/mothur_tools.R")
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
```

Next, we'll set the aesthetics of the figures we will produce

```{r figure_setup}
my.cols <- RColorBrewer::brewer.pal(n = 4, name = "Greys")[3:4]

# Set theme for figures in the paper
theme_set(theme_classic() + 
  theme(axis.title = element_text(size = 16),
        axis.title.x = element_text(margin = margin(t = 15, b = 15)),
        axis.title.y = element_text(margin = margin(l = 15, r = 15)),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(margin = margin(t = 5)),
        axis.text.y = element_text(margin = margin(r = 5)),
        #axis.line.x = element_line(size = 1),
        #axis.line.y = element_line(size = 1),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.x = element_line(size = 1),
        axis.ticks.y = element_line(size= 1),
        axis.ticks.length = unit(.1, "in"),
        panel.border = element_rect(color = "black", fill = NA, size =1.5),
        legend.title = element_blank(),
        legend.text = element_text(size = 14),
        strip.text = element_text(size = 14),
        strip.background = element_blank()
        ))
```

## Import Data

Here, we read in the processed sequence files from mothur (shared and taxonomy) and a design of the sampling. We also load in the environmental data. We then remove the mock community from the dataset and ensure the the design and OTU table are aligned by row



```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
# Taxonomy = Taxonomic information for each OTU
design <- "data/UL.design.txt"
shared <- "data/ul_resgrad.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.opti_mcc.shared"
taxon  <- "data/ul_resgrad.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.opti_mcc.0.03.cons.taxonomy"

# Import Design
design <- read.delim(design, header=T, row.names=1)

# Import Shared Files
otus <- read.otu(shared = shared, cutoff = "0.03")    # 97% Similarity

# Import Taxonomy
otu.taxonomy <- read.tax(taxonomy = taxon, format = "rdp")

#otus <- otus[str_which(rownames(otus), "RG"),]
otus <- otus[-which(rownames(otus) == "RGMockComm"),]
set.seed(12742899)

otus <- rrarefy(otus, min(rowSums(otus)))
print(length(which(otus == 0)))  #23630524
otus.relative.abundance <- decostand(otus, "total")
```


# Are the "persistent" reservoir taxa really representative? Look over time...

```{r time_series, fig.asp=1}
# Subset to just the time series sites
timeseries.otus <- otus[str_which(rownames(otus), "UL"),]

# make sure OTU table matches up with design order
timeseries.design <- read_csv("data/UL_timeseries_design.csv")
timeseries.otus <- timeseries.otus[match(timeseries.design$sample.name, 
                                         rownames(timeseries.otus)),]

# separate RNA and DNA dynamics
timeseries.otus.rna <- decostand(timeseries.otus[which(timeseries.design$sample.type == "RNA"),], 
                                 method = "total")
timeseries.otus.dna <- decostand(timeseries.otus[which(timeseries.design$sample.type == "DNA"),], 
                                 method = "total")
timeseries.otus.dna.presence <- decostand(timeseries.otus.dna + timeseries.otus.rna, 
                                          "pa")
timeseries.otus.rna.presence <- decostand(timeseries.otus.rna, 
                                          "pa")


timeseries.environment.data <- read.table("data/ul-seedbank.env.txt", sep="\t", header=TRUE)
timeseries.environment.data$date <- as.Date(parse_date_time(timeseries.environment.data$date, "m d y"))
timeseries.environment.data$doc[which(timeseries.environment.data$doc == "**")] <- NA
timeseries.environment.data$doc <- as.numeric(timeseries.environment.data$doc)
summary(timeseries.environment.data)
timeseries.design <- left_join(timeseries.design, timeseries.environment.data[,c("sample.id", "date")])
timeseries.environment.data <- timeseries.environment.data[-which(!(timeseries.environment.data$date %in% 
                                                                      timeseries.design$date)),]
```


```{r}
soil.otus <- otus[str_which(rownames(otus), "RGSoil"),] 
in.soils <- soil.otus[,which(colSums(soil.otus) > 0)]

soil.taxa <- colnames(in.soils)
nonsoil.taxa <- colnames(soil.otus[,which(colSums(soil.otus) == 0)])

length(soil.taxa) + length(nonsoil.taxa) == ncol(otus)


max.abundance.in.soils <- apply(decostand(soil.otus, "total"), MARGIN = 2, max)
common.in.soils <- names(max.abundance.in.soils[which(max.abundance.in.soils >= 0.001)])
rare.in.soils <- names(max.abundance.in.soils[which(max.abundance.in.soils < 0.001)])
length(common.in.soils) + length(rare.in.soils) == ncol(otus)

# pull out time series of taxa in soils
timeseries.rna.to.plot <- timeseries.otus.rna[,which(colMeans(timeseries.otus.dna.presence) > .2)] # present in half samples

soil.otus.to.plot <- timeseries.otus.rna[, which(colnames(timeseries.rna.to.plot) %in% soil.taxa)]

# pull out taxa not detected in soils
nonsoil.otus.to.plot <- timeseries.otus.rna[, which(colnames(timeseries.rna.to.plot) %in% nonsoil.taxa)]

ncol(soil.otus.to.plot) + ncol(nonsoil.otus.to.plot) == ncol(timeseries.rna.to.plot)

otu.trends.to.plot <- 
  cbind.data.frame(timeseries.design[which(timeseries.design$sample.type == "RNA"),], 
                                       soil.otus.to.plot) %>% as_tibble() %>% 
  gather(-sample.name, -sample.type, -sample.id, -date, key = OTU, value = rel_abund) %>% 
  mutate(soils = ifelse(OTU %in% nonsoil.taxa, "Absent from soils",
                   ifelse(OTU %in% common.in.soils, "Common in soils", "Rare in soils")))

otu.trends.to.plot %>% 
  ggplot(aes(x = date, y = rel_abund + 1e-4, group = OTU)) +
  geom_point(alpha = .1) + 
  geom_line(color = "blue",
            alpha = 0.5) +
  geom_vline(aes(xintercept = as_date("2013-07-15"))) +
  scale_y_log10() + 
  scale_x_date(labels = scales::date_format(format = "%b %y")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~soils, ncol = 1) +
  labs(x = "",
       y = "Relative abundance")
  

```







Classifying Middle otus in RG samples, the classification will help focus on a smaller
section of the otus closer to the Time series collection to get a better
activity representation instead of far way points which might be too different.

```{r}

transect.middle.otu <-otus.relative.abundance[c("RGD08", "RGD09", "RGD10", "RGD11", "RGc08", "RGc09", "RGc10", "RGc11"),]


#otus always active
transect.middle.rna.mean <- as.data.frame(t(colMeans(
  transect.middle.otu[str_which(rownames(transect.middle.otu), "RGc"), ])))
transect.middle.active.otus <- transect.middle.rna.mean[, which(transect.middle.rna.mean[1, ] > 0)]
names.transect.middle.active.otus<- colnames(transect.middle.active.otus)
transect.middle.active.soil.otus <- transect.middle.active.otus[, which(
  colnames(transect.middle.active.otus) %in% soil.taxa)]

#otus never active
transect.middle.dna <- as.data.frame(t(colMeans(
  transect.middle.otu[str_which(rownames(transect.middle.otu), "RGD"),])))

 
```



changing wide form to long form, for code and plot efficiency
```{r}
timeseries.otus.long<- timeseries.otus.rna |> as_tibble() |> 
  rownames_to_column( var= "sample.id" ) |> 
  mutate(sample.id= as.integer(sample.id)) |> 
  pivot_longer(names_to = "OTU", values_to = "relative.abundance", cols = -sample.id) |> 
  left_join(timeseries.environment.data, by= "sample.id" )

timeseries.otus.long |> filter(OTU %in% names.transect.middle.active.otus) |> 
  filter( OTU %in% soil.taxa) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU))+
  geom_line(alpha = 0.3)+
  scale_y_log10()

```

Plotting soil otus detected in transect from soil DNA and RNA
```{r}

#filtering transact data fractionally
transect.otus <- otus[str_which(rownames(otus), "RG"),] 
print(length(which(transect.otus == 0))) #3234533 

# separate RNA and DNA dynamics
transect.otus.rna <- transect.otus[str_which(rownames(transect.otus), "RGc"),] 
print(length(which(transect.otus.rna == 0))) #1498062 

transect.otus.dna <- transect.otus[str_which(rownames(transect.otus), "RGD"),] 
print(length(which(transect.otus.dna == 0))) #1491145 
 

transect.otus.dna.presence <- decostand(transect.otus.dna + transect.otus.rna, "pa") 
print(length(which(transect.otus.dna.presence == 1))) #10082
print(length(which(transect.otus.dna.presence == 0))) #1490092

transect.otus.rna.presence <- decostand(transect.otus.rna, "pa") 
print(length(which(transect.otus.rna.presence == 1))) #2112 
print(length(which(transect.otus.rna.presence == 0))) #1498062

transect.otus.dna2.presence <- decostand(transect.otus.dna, "pa") 
print(length(which(transect.otus.dna2.presence == 1))) #9029 
print(length(which(transect.otus.dna2.presence == 0))) #1491145

#transect.soil.1<- transect.otus.rna.presence[1, transect.otus.rna.presence[1,]==1, drop= FALSE]
#sample code to use in the loop


for (k in 1:18) {
  
  # Create a dynamic variable name
  a <- paste("transect.soil.otu.rna.", k, sep = "")
  
  b<- transect.otus.rna.presence[k, transect.otus.rna.presence[k, ] == 1, drop = FALSE]
  
  # Subset the data based on the dynamic variable name
  assign(a, b[, colnames(b) %in% soil.taxa])
  
}


transect.soil.otu.rna.all <- 
  unique(c(names(transect.soil.otu.rna.1),names(transect.soil.otu.rna.2),names(transect.soil.otu.rna.3),
           names(transect.soil.otu.rna.4),names(transect.soil.otu.rna.5),names(transect.soil.otu.rna.6),
           names(transect.soil.otu.rna.7),names(transect.soil.otu.rna.8),names(transect.soil.otu.rna.9),
           names(transect.soil.otu.rna.10),names(transect.soil.otu.rna.11),names(transect.soil.otu.rna.12),
           names(transect.soil.otu.rna.13),names(transect.soil.otu.rna.14),names(transect.soil.otu.rna.15),
           names(transect.soil.otu.rna.16),names(transect.soil.otu.rna.17),names(transect.soil.otu.rna.18)))


#220
for (k in 1:18) {
  a<- paste("transect.soil.otu.rna.", k, sep = "")
print(length(which(get(a) == 1)))
}



timeseries.otus.long |> filter( OTU %in% transect.soil.otu.rna.all) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)



for (k in 1:18) {
  
  # Create a dynamic variable name
  a <- paste("transect.soil.otu.dna.", k, sep = "")
  
  b<- transect.otus.dna.presence[k, transect.otus.dna.presence[k, ] == 1, drop = FALSE]
  
  # Subset the data based on the dynamic variable name
  assign(a, b[, colnames(b) %in% soil.taxa])
  
}

transect.soil.otu.dna.all <- 
  unique(c(names(transect.soil.otu.dna.1),names(transect.soil.otu.dna.2),names(transect.soil.otu.dna.3),
           names(transect.soil.otu.dna.4),names(transect.soil.otu.dna.5),names(transect.soil.otu.dna.6),
           names(transect.soil.otu.dna.7),names(transect.soil.otu.dna.8),names(transect.soil.otu.dna.9),
           names(transect.soil.otu.dna.10),names(transect.soil.otu.dna.11),names(transect.soil.otu.dna.12),
           names(transect.soil.otu.dna.13), names(transect.soil.otu.dna.14),names(transect.soil.otu.dna.15),
          names(transect.soil.otu.dna.16),names(transect.soil.otu.dna.17),names(transect.soil.otu.dna.18)))
#957

for (k in 1:18) {
  a<- paste("transect.soil.otu.dna.", k, sep = "")
print(length(which(get(a) == 1)))
}


timeseries.otus.long |> filter( OTU %in% transect.soil.otu.dna.all) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)




timeseries.otus.rna.present.atl.once<- timeseries.otus.rna.presence[, colSums(timeseries.otus.rna.presence) >0]


transect.soil.otus.dna.present.atl.once.timeseries.rna<-
  timeseries.otus.rna.present.atl.once[,colnames(timeseries.otus.rna.present.atl.once)
                                       %in% transect.soil.otu.dna.all]
#536


timeseries.otus.long |> 
  filter( OTU %in% colnames(transect.soil.otus.dna.present.atl.once.timeseries.rna)) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  scale_y_log10()



timeseries.otus.long |> 
  filter( OTU %in% colnames(transect.soil.otus.dna.present.atl.once.timeseries.rna[,31:60])) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ OTU, scales = "free_y")


```






Studying Sorted Soil Soil otus in Time series
(these were manually sorted)
Loading objects
```{r}
timeseries.soil.otus.dna.always <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                              sheet = "timeseries.soil.otus.dna.always")

timeseries.soil.otus.dna.blips <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                             sheet = "timeseries.soil.otus.dna.blips")

timeseries.soil.otus.dna.fh <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                          sheet = "timeseries.soil.otus.dna.fh")

timeseries.soil.otus.dna.s1 <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                          sheet = "timeseries.soil.otus.dna.s1")

timeseries.soil.otus.dna.s2 <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                          sheet = "timeseries.soil.otus.dna.s2")

timeseries.soil.otus.dna.s3 <- read_excel("soil_otu_activity_pattern/sortedotus.xlsx", 
                                          sheet = "timeseries.soil.otus.dna.s3")

```



Looking at Dynamics
```{r}
timeseries.otus.long |> 
  filter( OTU %in% timeseries.soil.otus.dna.always$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  scale_y_log10()

timeseries.otus.long |> 
  filter( OTU %in% timeseries.soil.otus.dna.blips$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  scale_y_log10()

timeseries.otus.long |> 
  filter( OTU %in% (timeseries.soil.otus.dna.always[1:50,])$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ OTU, scales = "free_y")

```



Trying to plot the presence data in long form
```{r}
timeseries.otus.long.presence<- 
  timeseries.otus.rna.presence |> as_tibble() |> 
  rownames_to_column( var= "sample.id" ) |> 
  mutate(sample.id= as.integer(sample.id)) |> 
  pivot_longer(names_to = "OTU", values_to = "relative.abundance", cols = -sample.id) |> 
  left_join(timeseries.environment.data, by= "sample.id" )

timeseries.otus.long.presence |> 
  filter( OTU %in% timeseries.soil.otus.dna.always$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  #scale_y_log10()+
  facet_wrap(~OTU)

timeseries.otus.long.presence |> 
  filter( OTU %in% timeseries.soil.otus.dna.fh$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  scale_y_log10()+
  facet_wrap(~OTU)

timeseries.otus.long.presence |> 
  filter( OTU %in% (timeseries.soil.otus.dna.blips[1:50,])$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ OTU, scales = "free_y")


```



Sorting from RNA transect data and their activity in the time series
```{r}

transect.soil.otus.rna.present.atl.once.timeseries.rna<- 
  as.data.frame(timeseries.otus.rna.present.atl.once[,colnames(timeseries.otus.rna.present.atl.once)
                                                     %in% transect.soil.otu.rna.all])

timeseries.otus.long |> 
  filter( OTU %in% colnames(transect.soil.otus.rna.present.atl.once.timeseries.rna)) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  scale_y_log10()

timeseries.otus.long |> 
  filter( OTU %in% colnames(transect.soil.otus.rna.present.atl.once.timeseries.rna[,1:30])) |>
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU ))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ OTU, scales = "free_y")

```


Attempting to Classify activity patterns based on metrics.
```{r}
names.transect.soil.otus.dna.present.atl.once.timeseries.rna<- 
  tibble( OTU= colnames(transect.soil.otus.dna.present.atl.once.timeseries.rna))

classified.transect.soil.otus.dna.present.atl.once.timeseries.rna<- 
  names.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  mutate(active = if_else(colSums(transect.soil.otus.dna.present.atl.once.timeseries.rna)/124 > 0.9, "always",
                          if_else(colSums(transect.soil.otus.dna.present.atl.once.timeseries.rna)/124 < 0.1, 
                                  "blips", "seasonal")))

classified.transect.soil.otus.dna.present.atl.once.timeseries.rna |> count(active)

always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna<- 
  classified.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  filter(active== "always")

timeseries.otus.long.presence |> 
  filter(OTU %in% always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna<- 
  classified.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  filter(active== "seasonal")

timeseries.otus.long.presence |> 
  filter(OTU %in% seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna[1:35,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna<- 
  classified.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  filter(active== "blips")

timeseries.otus.long.presence |> 
  filter(OTU %in% blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna[1:35,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

```




Manually reassigned metric classified OTU to correct for patterns based on sustained activity
```{r}
new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  read_excel("soil_otu_activity_pattern/new.sortedotus.xlsx", sheet = "always")
new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  read_excel("soil_otu_activity_pattern/new.sortedotus.xlsx", sheet = "seasonal")
new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  read_excel("soil_otu_activity_pattern/new.sortedotus.xlsx", sheet = "blips")
new.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <-
  bind_rows(new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna,
            new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna) |>
  bind_rows(new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna)

```



Visualizing re-sorted otus
```{r}


timeseries.otus.long.presence |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  ggplot(aes(x = sample.id, y= relative.abundance, group= OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous(limits= c(-0.5,1.5))+
  theme_minimal()

timeseries.otus.long.presence |> 
  filter(OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous(limit = c(-0.5, 1.5))+
  theme_minimal()

timeseries.otus.long.presence |> 
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna[31:60,]$OTU) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous(limit = c(-0.5, 1.5))+
  theme_minimal()
```


Attempting to visualize the %contribution of the sorted otus to the dynamic active community
i.e if they were rare or common and what % of the active abundance did they make up
Only inspecting the RNA pool of the time series
```{r}
#ALways
soil.otus.always.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data = filter(timeseries.otus.long, OTU %in%
                            new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU),
            FUN = sum)

ggplot(data= soil.otus.always.active.abundance, 
       aes(x= sample.id, y= relative.abundance * 100), 
       group= sample.id)+
  geom_line( alpha= 1, color = "#3F2BBD")+
  labs(
    x = "Weeks",
    y = "Percent Abundance"
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text = element_text( size = 12)
  ) +
  scale_y_continuous( limits = c(0, 65))

ggsave(filename = "always_soil_taxa_percent_contriution.pdf", path = "./figures")

#Seasonal                                
soil.otus.seasonally.active.abundance <- 
  aggregate(relative.abundance ~ sample.id, 
            data =filter(timeseries.otus.long, OTU %in% 
                          new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU),
            FUN = sum)

ggplot(data= soil.otus.seasonally.active.abundance, 
       aes(x= sample.id, y= relative.abundance * 100), 
       group= sample.id)+
  geom_line( alpha= 1, color = "#3A8639")+
  labs(
    x = "Weeks",
    y = "Percent Abundance"
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text = element_text( size = 12)
  ) +
  scale_y_continuous( limits = c(0, 65))

ggsave(filename = "seasonal_soil_taxa_percent_contriution.pdf", path = "./figures")


#Blips
soil.otus.blips.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data =filter(timeseries.otus.long, OTU %in%
                           new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU),
            FUN = sum)

ggplot(
  data= soil.otus.blips.active.abundance, 
  aes(x= sample.id, y= relative.abundance * 100), group= sample.id)+
  geom_line( alpha= 1, color = "#A42F2F")+
  labs(
    x = "Weeks",
    y = "Percent Abundance"
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text = element_text( size = 12)
  ) +
  scale_y_continuous( limits = c(0, 65))

ggsave(filename = "blips_soil_taxa_percent_contriution.pdf", path = "./figures")

#view(filter(otu.taxonomy, OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))
#view(filter(otu.taxonomy, OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))
#view(filter(otu.taxonomy, OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))

```



Trying to figure out if these sorted otus are rare or common in aquatic community
```{r}

timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  theme_minimal()


timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()



timeseries.otus.long |> 
  filter(OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>   
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()

timeseries.otus.long |> 
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna[91:120,]$OTU) |>
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()

```






Attempting to sort aquatic otus in the time series, i.e. otus not detected in soil samples
```{r}

timeseries.aquatic.otus.rna.present.atl.once<- 
  timeseries.otus.rna.present.atl.once[,!(colnames(timeseries.otus.rna.present.atl.once) %in% 
                                            transect.soil.otu.dna.all)]

names.timeseries.aquatic.otus.rna.present.atl.once<- 
  tibble( OTU= colnames(timeseries.aquatic.otus.rna.present.atl.once))

classified.timeseries.aquatic.otus.rna.present.atl.once<- 
  names.timeseries.aquatic.otus.rna.present.atl.once |> 
  mutate(active = if_else(colSums(timeseries.aquatic.otus.rna.present.atl.once)/124 > 0.9, "always", 
                          if_else(colSums(timeseries.aquatic.otus.rna.present.atl.once)/124 < 0.1, "blips",
                                  "seasonal")))

classified.timeseries.aquatic.otus.rna.present.atl.once |> count(active)

write_xlsx(classified.timeseries.aquatic.otus.rna.present.atl.once, 
           "classified.timeseries.aquatic.otus.rna.present.atl.once.xlsx")


always.classified.timeseries.aquatic.otus.rna.present.atl.once<- 
  classified.timeseries.aquatic.otus.rna.present.atl.once |> 
  filter(active== "always")

write_xlsx(always.classified.timeseries.aquatic.otus.rna.present.atl.once,
           "always.classified.timeseries.aquatic.otus.rna.present.atl.once.xlsx")

timeseries.otus.long.presence |> 
  filter(OTU %in% always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once<- 
  classified.timeseries.aquatic.otus.rna.present.atl.once |> 
  filter(active== "seasonal")

write_xlsx(seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once, 
           "seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once.xlsx")


timeseries.otus.long.presence |> 
  filter(OTU %in% seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once[661:690,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

blips.classified.timeseries.aquatic.otus.rna.present.atl.once<- 
  classified.timeseries.aquatic.otus.rna.present.atl.once |> 
  filter(active== "blips")

write_xlsx(blips.classified.timeseries.aquatic.otus.rna.present.atl.once, 
           "blips.classified.timeseries.aquatic.otus.rna.present.atl.once.xlsx")

timeseries.otus.long.presence |> 
  filter(OTU %in% blips.classified.timeseries.aquatic.otus.rna.present.atl.once[101:200,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

```



%contribution
```{r}
aquatic.otus.always.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data = filter(timeseries.otus.long, OTU %in% 
                            always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU),
            FUN = sum)

ggplot(data= aquatic.otus.always.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id)+
  geom_line( alpha= 0.3)+
  theme_minimal()


aquatic.otus.seasonally.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data =filter(timeseries.otus.long, OTU %in% 
                           seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU),
            FUN = sum)
ggplot(data= aquatic.otus.seasonally.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id)+
  geom_line( alpha= 0.3)+
  theme_minimal()


aquatic.otus.blips.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data =filter(timeseries.otus.long, OTU %in% 
                           blips.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU),
           FUN = sum)

ggplot(data= aquatic.otus.blips.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id)+
  geom_line( alpha= 0.3)+
  theme_minimal()



#view(filter(otu.taxonomy, OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))
#view(filter(otu.taxonomy, OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))
#view(filter(otu.taxonomy, OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU))
```


aquatic OG rare or common
```{r}
timeseries.otus.long |> 
  filter(OTU %in% always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  theme_minimal()


timeseries.otus.long |> 
  filter(OTU %in% always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()



timeseries.otus.long |> 
  filter(OTU %in% seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once[20:50,]$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()

timeseries.otus.long |> 
  filter(OTU %in% blips.classified.timeseries.aquatic.otus.rna.present.atl.once[450:500,]$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()
```


loading re-sorted aquatic otus
```{r}
new.always.classified.timeseries.aquatic.otus.rna.present.atl.once <-
  read_csv("aquatic_otu_activity_pattern/new.always.classified.timeseries.aquatic.otus.rna.present.atl.once.csv")
new.seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once <- 
  read_csv("aquatic_otu_activity_pattern/new.seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once.csv")
new.blips.classified.timeseries.aquatic.otus.rna.present.atl.once <- 
  read_csv("aquatic_otu_activity_pattern/new.blips.classified.timeseries.aquatic.otus.rna.present.atl.once.csv")
```



plotting re-sorted aquatic otus
```{r}

timeseries.otus.long.presence |> 
  filter(OTU %in% new.always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

timeseries.otus.long.presence |> 
  filter(OTU %in% new.seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once[1:30,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()

timeseries.otus.long.presence |> 
  filter(OTU %in% new.blips.classified.timeseries.aquatic.otus.rna.present.atl.once[1:30,]$OTU) |>
  ggplot(aes(x= sample.id, y= relative.abundance,group = OTU))+
  geom_line(alpha = 0.3)+
  facet_wrap(~OTU)+
  scale_y_continuous( limits = c(-0.5,1.5))+
  theme_minimal()
```



new aquatic %contributions
```{r}
new.aquatic.otus.always.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data = filter(timeseries.otus.long, OTU %in% 
                            new.always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU),
            FUN = sum)

ggplot(data= new.aquatic.otus.always.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id)+
  geom_line( alpha= 0.3)+
  theme_minimal()


new.aquatic.otus.seasonally.active.abundance<- 
  aggregate(relative.abundance ~ sample.id, 
            data =filter(timeseries.otus.long, 
                         OTU %in% new.seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU),
            FUN = sum)

ggplot(data= new.aquatic.otus.seasonally.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id)+
  geom_line( alpha= 0.3)+
  theme_minimal()


new.aquatic.otus.blips.active.abundance <- 
  aggregate(relative.abundance ~ sample.id, 
  data =filter(timeseries.otus.long, OTU %in%
                 new.blips.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU), 
  FUN = sum)


ggplot(data = new.aquatic.otus.blips.active.abundance, 
       aes(x= sample.id, y= relative.abundance), 
       group= sample.id) +
  geom_line( alpha= 0.3)+
  theme_minimal()

```


new aquatic rare or common
```{r}
timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |> 
  ggplot(aes(x= sample.id, y= relative.abundance, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  theme_minimal()


timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.timeseries.aquatic.otus.rna.present.atl.once$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()



timeseries.otus.long |> 
  filter(OTU %in% new.seasonal.classified.timeseries.aquatic.otus.rna.present.atl.once[20:50,]$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()

timeseries.otus.long |> 
  filter(OTU %in% new.blips.classified.timeseries.aquatic.otus.rna.present.atl.once[450:500,]$OTU) |> 
  mutate(type= if_else(relative.abundance >= 0.001, 1, 0)) |> 
  ggplot(aes(x= sample.id, y= type, group= OTU))+
  geom_line( alpha =0.3)+
  facet_wrap(~ OTU)+
  scale_y_continuous(limits = c(-0.5, 1.5))+
  theme_minimal()
```




what in %contribution is coming from rare or common otus

for always OTU
```{r}

timeseries.otus.long<- 
  timeseries.otus.long |> 
  mutate(abundance.type= if_else(relative.abundance >= 0.001, 1, 0))

commonly.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 1) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum) |> 
  rename(common.abundance = relative.abundance)

rarely.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 0) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(rare.abundance = relative.abundance)

aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  soil.otus.always.active.abundance |> 
  rename(aggregate.abundance = relative.abundance) |>
  left_join(commonly.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |>
  left_join(rarely.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |> 
  mutate_all(~replace_na(.,0)) |>
  pivot_longer(cols = contains('abundance'), names_to = 'abundance.type', values_to = 'abundance')
  

ggplot(aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
       aes(x = sample.id, y = abundance, color = abundance.type))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ abundance.type) +
  theme_minimal()

```

for seasonal otus

```{r}


commonly.abundant.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 1) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum) |> 
  rename(common.abundance = relative.abundance)

rarely.abundant.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 0) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(rare.abundance = relative.abundance)

aggregate.abundance.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  soil.otus.seasonally.active.abundance |> 
  rename(aggregate.abundance = relative.abundance) |>
  left_join(commonly.abundant.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |>
  left_join(rarely.abundant.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |> 
  mutate_all(~replace_na(.,0)) |>
  pivot_longer(cols = contains('abundance'), names_to = 'abundance.type', values_to = 'abundance')
  

ggplot(aggregate.abundance.new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
       aes(x = sample.id, y = abundance, color = abundance.type))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ abundance.type) +
  theme_minimal()

```



for blips otus
```{r}
commonly.abundant.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 1) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum) |> 
  rename(common.abundance = relative.abundance)

rarely.abundant.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 0) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(rare.abundance = relative.abundance)

aggregate.abundance.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  soil.otus.blips.active.abundance |> 
  rename(aggregate.abundance = relative.abundance) |>
  left_join(commonly.abundant.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |>
  left_join(rarely.abundant.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |> 
  mutate_all(~replace_na(.,0)) |>
  pivot_longer(cols = contains('abundance'), names_to = 'abundance.type', values_to = 'abundance')
  

ggplot(aggregate.abundance.new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
       aes(x = sample.id, y = abundance, color = abundance.type))+
  geom_line(alpha = 0.3)+
  facet_wrap(~ abundance.type) +
  theme_minimal()


```


*Start here
%contribution of soil otus to community, ALL TOGETHER
```{r}
total.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(aggregate.abundance = relative.abundance)

rare.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 0) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(rare.abundance = relative.abundance)

common.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  timeseries.otus.long |> 
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 1) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(common.abundance = relative.abundance)

aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna <- 
  total.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  left_join(rare.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna, by = 'sample.id') |> 
  left_join(common.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna, by = 'sample.id') |> 
  mutate_all(~replace_na(.,0)) |> 
  pivot_longer(cols = contains('abundance'), names_to = 'abundance.type', values_to = 'abundance')


ggplot(aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
       aes(x = sample.id, y = abundance * 100, color = abundance.type)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~abundance.type, labeller = labeller( abundance.type = 
                                    c(aggregate.abundance = "All Taxa",
                                      common.abundance = "Common Taxa", 
                                      rare.abundance = "Rare Taxa"))) +
  guides(color = "none") +
  labs(
    x = "Weeks", 
    y = " Percent Abundance \nfrom Active Soil Taxa" ) +
  theme(
    axis.title = element_text(face = "bold", size = 20),
    axis.text = element_text(size = 10)) + 
  scale_color_manual( values = c( "aggregate.abundance" = "#460E5F", #purple
                                  "common.abundance" = "#B16415", #orange
                                  "rare.abundance" = "#237B75" #teal
                                  ))
  

ggsave(filename = "percent_contribution_of_active_soil_taxa_in_aquatic_community.jpeg", 
       path = "./figures")
  


aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide <- 
  total.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna |> 
  left_join(rare.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna, by = 'sample.id') |> 
  left_join(common.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna, by = 'sample.id') |> 
  mutate_all(~replace_na(.,0))

aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide |> 
  mutate(ratio.common.to.rare = 
           aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide$common.abundance / 
           aggregate.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide$rare.abundance) |> 
  ggplot(aes(x = sample.id, y = ratio.common.to.rare)) +
  geom_line(alpha = 0.3)+
  theme_minimal()


aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide <- 
  soil.otus.always.active.abundance |> 
  left_join(rarely.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |> 
  left_join(commonly.abundant.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, 
            by = 'sample.id') |> 
  mutate_all(~replace_na(.,0))

#Ratio of common to rare aggregate abundance
aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide |> 
  mutate(ratio.common.to.rare = 
           aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide$common.abundance / 
           aggregate.abundance.new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna.wide$rare.abundance) |> 
  ggplot(aes(x = sample.id, y = ratio.common.to.rare)) +
  geom_line(alpha = 0.3)+
  theme_minimal()

```



%contribution of aquatic otus to community, ALL TOGETHER
```{r}
total.abundance.timeseries.aquatic.otus.rna.present.atl.once <- 
  timeseries.otus.long |> 
  filter(OTU %in% names.timeseries.aquatic.otus.rna.present.atl.once$OTU) |>
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(aggregate.abundance = relative.abundance)

rare.abundance.timeseries.aquatic.otus.rna.present.atl.once<- 
  timeseries.otus.long |> 
  filter(OTU %in% names.timeseries.aquatic.otus.rna.present.atl.once$OTU) |>
  filter(abundance.type == 0) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(rare.abundance = relative.abundance)

common.abundance.timeseries.aquatic.otus.rna.present.atl.once<- 
  timeseries.otus.long |> 
  filter(OTU %in% names.timeseries.aquatic.otus.rna.present.atl.once$OTU) |>
  filter(abundance.type == 1) |> 
  aggregate(relative.abundance ~ sample.id, FUN = sum)|> 
  rename(common.abundance = relative.abundance)

aggregate.abundance.timeseries.aquatic.otus.rna.present.atl.once <- 
  total.abundance.timeseries.aquatic.otus.rna.present.atl.once |> 
  left_join(rare.abundance.timeseries.aquatic.otus.rna.present.atl.once, by = 'sample.id') |> 
  left_join(common.abundance.timeseries.aquatic.otus.rna.present.atl.once, by = 'sample.id') |> 
  mutate_all(~replace_na(.,0)) |> 
  pivot_longer(cols = contains('abundance'), names_to = 'abundance.type', values_to = 'abundance')

ggplot(aggregate.abundance.timeseries.aquatic.otus.rna.present.atl.once, 
       aes(x = sample.id, y = abundance, color = abundance.type)) +
  geom_line(alpha = 0.3)+
  facet_wrap(~abundance.type)+
  theme_minimal()


(total.abundance.timeseries.aquatic.otus.rna.present.atl.once$aggregate.abundance + 
    total.abundance.transect.soil.otus.dna.present.atl.once.timeseries.rna$aggregate.abundance)

timeseries.otus.long |> 
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(abundance.type == 1) |> 
  select(OTU) |> 
  unique()



```





Checking what % of active soil OTUs are common vs rare dynamically

```{r}
#All soil OTUs that were active atleast once (fixed number of OTUs in each sample.id)
percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna <-
  timeseries.otus.long |> 
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU)|>
  group_by(sample.id) |> 
  summarise(
    total.active = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.active)*100,
    percent.rare = (total.rare / total.active)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))


ggplot(percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna,
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal()
  
#percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.common +
#  percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.rare == 536

#Active classified soil OTUs
percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna <-
  timeseries.otus.long |> 
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU)|>
  group_by(sample.id) |> 
  summarise(
    total.active = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.active)*100,
    percent.rare = (total.rare / total.active)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))


ggplot(percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna,
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal()

#Soil OTUs only when present (dynamic number of OTUs in each sample.id)
when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna <-
  timeseries.otus.long |> 
  mutate(presence = timeseries.otus.long.presence$relative.abundance)|>
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(presence == 1) |> 
  group_by(sample.id) |> 
  summarise(
    total.present = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.present)*100,
    percent.rare = (total.rare / total.present)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))
#when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.common +
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.rare == 
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.present

ggplot(when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna,
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal()  

#Always classified
when.present.percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  timeseries.otus.long |> 
  mutate(presence = timeseries.otus.long.presence$relative.abundance)|>
  filter(OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(presence == 1) |> 
  group_by(sample.id) |> 
  summarise(
    total.present = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.present)*100,
    percent.rare = (total.rare / total.present)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))

when.present.percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna$active.type = "always"
#when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.common +
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.rare == 
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.present

ggplot(when.present.percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna,
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal() 


#blips classified
when.present.percent.common.blips.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  timeseries.otus.long |> 
  mutate(presence = timeseries.otus.long.presence$relative.abundance)|>
  filter(OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(presence == 1) |> 
  group_by(sample.id) |> 
  summarise(
    total.present = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.present)*100,
    percent.rare = (total.rare / total.present)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))

when.present.percent.common.blips.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna$active.type = "blips"
#when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.common +
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.rare == 
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.present

ggplot(when.present.percent.common.blips.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna, 
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal() 


#seasonal Classified
when.present.percent.common.seasonal.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  timeseries.otus.long |> 
  mutate(presence = timeseries.otus.long.presence$relative.abundance)|>
  filter(OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(presence == 1) |> 
  group_by(sample.id) |> 
  summarise(
    total.present = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.present)*100,
    percent.rare = (total.rare / total.present)*100,
  ) |> 
  mutate(mean.percent.common = mean(percent.common))

when.present.percent.common.seasonal.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna$active.type = "seasonal"
#when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.common +
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.rare == 
#  when.present.percent.common.transect.soil.otus.rna.present.atl.once.timeseries.rna$total.present

ggplot(when.present.percent.common.seasonal.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna, 
       aes(x= sample.id, y= percent.common)) +
  geom_line(alpha = 0.3) +
  theme_minimal() 

when.present.percent.common.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna <-
  bind_rows(when.present.percent.common.always.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna, 
            when.present.percent.common.seasonal.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna)|>
  bind_rows(when.present.percent.common.blips.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna)

```



of the times precent, what percent of time are they common?
```{r}
when.present.percent.of.time.common.transect.soil.otus.rna.present.atl.once.timeseries.rna <-
  timeseries.otus.long |> 
  mutate(presence = timeseries.otus.long.presence$relative.abundance)|>
  filter(OTU %in% names.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |>
  filter(presence == 1) |> 
  group_by(OTU) |> 
  summarise(
    total.present = n(),
    total.common = sum(abundance.type == 1),
    total.rare = sum(abundance.type == 0),
    percent.common = (total.common / total.present)*100,
    percent.rare = (total.rare / total.present)*100
  ) |> 
  mutate(mean.percent.common = mean(percent.common)) |> 
  left_join(new.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna, by = "OTU") |> 
  rename( active.type = active)
  

when.present.percent.of.time.common.alway.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  when.present.percent.of.time.common.transect.soil.otus.rna.present.atl.once.timeseries.rna |> 
  filter( OTU %in% new.always.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  mutate(mean.percent.common = mean(percent.common))

when.present.percent.of.time.common.seasonal.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  when.present.percent.of.time.common.transect.soil.otus.rna.present.atl.once.timeseries.rna |> 
  filter( OTU %in% new.seasonal.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  mutate(mean.percent.common = mean(percent.common))

when.present.percent.of.time.common.blips.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna<-
  when.present.percent.of.time.common.transect.soil.otus.rna.present.atl.once.timeseries.rna |> 
  filter( OTU %in% new.blips.classified.transect.soil.otus.dna.present.atl.once.timeseries.rna$OTU) |> 
  mutate(mean.percent.common = mean(percent.common))


```




Make box plots 1) %OTUs, 2)%of time

```{r}

when.present.percent.of.time.common.transect.soil.otus.rna.present.atl.once.timeseries.rna |>
  mutate(active.type = factor(active.type, levels = c("blips", "seasonal", "always"))) |> 
  ggplot(aes(x = active.type, y = percent.common, color = active.type)) +
  geom_boxplot() +
  guides( color = "none") +
  labs( x = "Activity Pattern", y = "Percent of time \ncommon when present") +
  scale_x_discrete(labels = 
                     c("blips" = "Momentarily \nActive", 
                       "seasonal" = "Seasonally \nActive", 
                       "always" = "Always \nActive")) +
  theme(
    axis.title = element_text(face = "bold", size = 20),
    axis.text = element_text(size = 15),
    plot.margin = margin(20, 10),
    axis.title.y = element_text(hjust = 0.72)) +
  scale_color_manual( values = c( "blips" = "#A42F2F", #red
                                  "seasonal" = "#3A8639", #green
                                  "always" = "#3F2BBD" #blue
                                  ))

ggsave("soil_taxa_percent_of_times_common_when_present.pdf", path = "./figures")

when.present.percent.common.classified.transect.soil.otus.rna.present.atl.once.timeseries.rna |> 
  mutate(active.type = factor(active.type, levels = c( "blips", "seasonal", "always"))) |> 
  ggplot(aes(x = active.type, y = percent.common, color = active.type)) +
  geom_boxplot() +
  guides(color = "none") +
  labs( x = "Activity Pattern", y = "Percent of taxa \ncommon when present") +
  scale_x_discrete(labels = 
                     c("blips" = "Momentarily \nActive", 
                       "seasonal" = "Seasonally \nActive", 
                       "always" = "Always \nActive")) +
  theme(
    axis.title = element_text(face = "bold", size = 20),
    axis.text = element_text(size = 15),
    plot.margin = margin(20, 20),
    axis.title.y = element_text( hjust = 0.72)) +
  scale_color_manual( values = c( "blips" = "#A42F2F", #red
                                  "seasonal" = "#3A8639", #green
                                  "always" = "#3F2BBD" #blue
                                  ))

ggsave("percent_of_soil_taxa_common_when_present.pdf", path = "./figures")

```


Getting example OTUs to represent different activity patterns

```{r}
#Always: selected Otu00001
timeseries.otus.long.presence |> 
  filter(OTU == "Otu00001") |> 
  ggplot(aes(x = sample.id, y = relative.abundance)) +
  facet_wrap(~OTU) +
  geom_line( alpha = 1, color = "#3F2BBD") +
  scale_y_continuous( limits = c(-0.5, 1.5)) +
  labs(
    x = "Weeks",
    y = ""
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text.x = element_text( size = 12)
  )

ggsave("always_example_otu.pdf", path = "./figures")


#Seasonal: selected Otu00078
timeseries.otus.long.presence |> 
  filter(OTU == "Otu00078") |> 
  ggplot(aes(x = sample.id, y = relative.abundance)) +
  facet_wrap(~OTU) +
  geom_line( alpha = 1, color = "#3A8639") +
  scale_y_continuous( limits = c(-0.5, 1.5)) +
  labs(
    x = "Weeks",
    y = ""
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text.x = element_text( size = 12)
  )

ggsave("seasonal_example_otu.pdf", path = "./figures")



#Blips: selected Otu00042
timeseries.otus.long.presence |> 
  filter(OTU == "Otu00042") |> 
  ggplot(aes(x = sample.id, y = relative.abundance)) +
  facet_wrap(~OTU,) +
  geom_line( alpha = 1, color = "#A42F2F" ) +
  scale_y_continuous( limits = c(-0.5, 1.5)) +
  labs(
    x = "Weeks",
    y = ""
  ) +
  theme(
    axis.title = element_text( face = "bold", size = 20),
    axis.text.x = element_text( size = 12),
  )

ggsave("blips_example_otu.pdf", path = "./figures")


```

